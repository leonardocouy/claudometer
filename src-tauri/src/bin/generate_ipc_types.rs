use std::fs;
use std::path::PathBuf;
use ts_rs::TS;

fn write_decl<T: TS>(out: &mut String) {
    let mut decl = T::decl();
    let trimmed = decl.trim_start();
    if trimmed.starts_with("type ") {
        decl = decl.replacen("type ", "export type ", 1);
    } else if trimmed.starts_with("interface ") {
        decl = decl.replacen("interface ", "export interface ", 1);
    } else if trimmed.starts_with("enum ") {
        decl = decl.replacen("enum ", "export enum ", 1);
    }
    out.push_str(&decl);
    if !out.ends_with('\n') {
        out.push('\n');
    }
    out.push('\n');
}

fn main() {
    let manifest_dir = PathBuf::from(env!("CARGO_MANIFEST_DIR"));
    let repo_root = manifest_dir
        .parent()
        .expect("src-tauri must have a parent directory");
    let out_path = repo_root.join("src/common/generated/ipc-types.ts");

    if let Some(parent) = out_path.parent() {
        fs::create_dir_all(parent).expect("create generated output directory");
    }

    let mut out = String::new();
    out.push_str("// @generated\n");
    out.push_str("// This file is generated by `cargo run --manifest-path src-tauri/Cargo.toml --bin generate_ipc_types`.\n");
    out.push_str("// Do not edit manually.\n\n");

    write_decl::<claudometer_lib::types::UsageStatus>(&mut out);
    write_decl::<claudometer_lib::types::UsageSource>(&mut out);
    write_decl::<claudometer_lib::types::CodexUsageSource>(&mut out);

    write_decl::<claudometer_lib::types::ClaudeModelUsage>(&mut out);
    write_decl::<claudometer_lib::types::ClaudeUsageSnapshot>(&mut out);
    write_decl::<claudometer_lib::types::CodexUsageSnapshot>(&mut out);
    write_decl::<claudometer_lib::types::UsageSnapshotBundle>(&mut out);

    write_decl::<claudometer_lib::types::ClaudeOrganization>(&mut out);
    write_decl::<claudometer_lib::types::SettingsState>(&mut out);
    write_decl::<claudometer_lib::types::SaveSettingsPayload>(&mut out);

    write_decl::<claudometer_lib::types::IpcErrorCode>(&mut out);
    write_decl::<claudometer_lib::types::IpcError>(&mut out);

    // Export the generic result envelope used by IPC responses.
    write_decl::<claudometer_lib::types::IpcResult<()>>(&mut out);

    fs::write(&out_path, out).expect("write generated file");
    println!("Wrote {}", out_path.display());
}
